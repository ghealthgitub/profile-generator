<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äî Ginger Universe</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:#F0F2F5;color:#1F2937;min-height:100vh}

        /* ‚îÄ‚îÄ Topbar ‚îÄ‚îÄ */
        .topbar{
            background:linear-gradient(135deg,#0B2545,#13315C);color:white;
            padding:0 28px;height:56px;display:flex;align-items:center;justify-content:space-between;
            box-shadow:0 2px 12px rgba(11,37,69,.25);position:sticky;top:0;z-index:100;
        }
        .topbar-left{display:flex;align-items:center;gap:12px}
        .topbar-logo{width:34px;height:34px;background:#F26522;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px}
        .topbar-title{font-family:'Playfair Display',serif;font-size:18px;font-weight:700}
        .topbar-right{display:flex;align-items:center;gap:14px;font-size:13px}
        .badge{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
        .badge-green{background:rgba(16,185,129,.2);color:#6EE7B7}
        .badge-amber{background:rgba(251,191,36,.2);color:#FCD34D}
        .badge-blue{background:rgba(59,130,246,.2);color:#93C5FD}
        .topbar-nav{display:flex;gap:4px}
        .topbar-nav a{
            color:rgba(255,255,255,.7);text-decoration:none;padding:6px 14px;
            border-radius:6px;font-size:13px;font-weight:500;transition:all .2s;
        }
        .topbar-nav a:hover,.topbar-nav a.active{background:rgba(255,255,255,.1);color:white}
        .btn-sm{padding:5px 14px;border-radius:6px;font-size:12px;font-weight:600;border:none;cursor:pointer;font-family:inherit;text-decoration:none}
        .btn-ghost{background:rgba(255,255,255,.1);color:white}
        .btn-ghost:hover{background:rgba(255,255,255,.2)}

        /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
        .main{max-width:1100px;margin:24px auto;padding:0 20px}

        /* ‚îÄ‚îÄ Stat Cards ‚îÄ‚îÄ */
        .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
        .stat-card{
            background:white;border-radius:12px;padding:20px;
            border:1px solid #E5E7EB;position:relative;overflow:hidden;
        }
        .stat-card::after{
            content:'';position:absolute;top:0;right:0;width:60px;height:60px;
            border-radius:0 0 0 60px;opacity:.08;
        }
        .stat-card:nth-child(1)::after{background:#0EA5A0}
        .stat-card:nth-child(2)::after{background:#F26522}
        .stat-card:nth-child(3)::after{background:#3B82F6}
        .stat-card:nth-child(4)::after{background:#8B5CF6}
        .stat-label{font-size:12px;color:#6B7280;font-weight:500;text-transform:uppercase;letter-spacing:.5px}
        .stat-value{font-size:28px;font-weight:700;color:#0B2545;margin:4px 0}
        .stat-sub{font-size:12px;color:#9CA3AF}

        /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
        .card{background:white;border-radius:12px;padding:24px;border:1px solid #E5E7EB;margin-bottom:20px}
        .card h2{font-family:'Playfair Display',serif;font-size:18px;color:#0B2545;margin-bottom:16px}
        .card h3{font-size:15px;font-weight:600;color:#0B2545;margin-bottom:12px}

        /* ‚îÄ‚îÄ URL Input Area ‚îÄ‚îÄ */
        .url-area{margin-bottom:12px}
        .url-row{display:flex;gap:8px;margin-bottom:8px;align-items:center}
        .url-input{
            flex:1;padding:10px 14px;border:2px solid #E5E7EB;border-radius:8px;
            font-size:14px;font-family:inherit;transition:border-color .2s;
        }
        .url-input:focus{outline:none;border-color:#0EA5A0;box-shadow:0 0 0 3px rgba(14,165,160,.08)}
        .url-remove{
            width:32px;height:32px;border:none;background:#FEE2E2;color:#DC2626;
            border-radius:6px;cursor:pointer;font-size:16px;flex-shrink:0;
        }
        .url-remove:hover{background:#FECACA}
        .add-url-btn{
            padding:8px 16px;background:#F0FDF4;color:#166534;border:1px dashed #86EFAC;
            border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;font-family:inherit;
        }
        .add-url-btn:hover{background:#DCFCE7}

        .btn-row{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
        .btn{
            padding:10px 22px;border:none;border-radius:8px;font-size:14px;
            font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s;
        }
        .btn-orange{background:#F26522;color:white}
        .btn-orange:hover{background:#D9541A;transform:translateY(-1px)}
        .btn-teal{background:#0EA5A0;color:white}
        .btn-teal:hover{background:#0C8C88}
        .btn-navy{background:#0B2545;color:white}
        .btn-navy:hover{background:#13315C}
        .btn-outline{background:white;color:#374151;border:2px solid #D1D5DB}
        .btn-outline:hover{border-color:#9CA3AF}
        .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}

        /* ‚îÄ‚îÄ Status ‚îÄ‚îÄ */
        .status-bar{padding:12px 16px;border-radius:8px;margin:12px 0;font-size:14px;font-weight:500;display:none}
        .status-bar.loading{display:flex;align-items:center;gap:10px;background:#FEF3C7;color:#92400E;border:1px solid #FDE68A}
        .status-bar.success{display:block;background:#D1FAE5;color:#065F46;border:1px solid #A7F3D0}
        .status-bar.error{display:block;background:#FEE2E2;color:#991B1B;border:1px solid #FECACA}
        .spinner{width:16px;height:16px;border:2.5px solid #FDE68A;border-top-color:#92400E;border-radius:50%;animation:spin .6s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* ‚îÄ‚îÄ Profile Editor ‚îÄ‚îÄ */
        .editor-area{
            width:100%;min-height:400px;padding:20px;border:2px solid #E5E7EB;border-radius:8px;
            font-size:14px;font-family:inherit;line-height:1.8;resize:vertical;
            transition:border-color .2s;
        }
        .editor-area:focus{outline:none;border-color:#0EA5A0}
        .editor-toolbar{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}

        /* ‚îÄ‚îÄ Scraped Data ‚îÄ‚îÄ */
        .scrape-summary{
            background:#F9FAFB;border:1px solid #E5E7EB;border-radius:8px;
            padding:16px;font-size:13px;margin-bottom:16px;
        }
        .scrape-summary .label{font-weight:600;color:#6B7280;margin-right:8px}
        .tag{
            display:inline-block;padding:2px 10px;border-radius:12px;
            font-size:11px;font-weight:600;margin:2px 3px;
        }
        .tag-blue{background:#EFF6FF;color:#1E40AF}
        .tag-green{background:#F0FDF4;color:#166534}
        .tag-orange{background:#FFF7ED;color:#9A3412}

        /* ‚îÄ‚îÄ History Table ‚îÄ‚îÄ */
        .history-table{width:100%;border-collapse:collapse;font-size:13px}
        .history-table th{text-align:left;padding:10px 12px;background:#F9FAFB;border-bottom:2px solid #E5E7EB;font-weight:600;color:#6B7280;font-size:11px;text-transform:uppercase;letter-spacing:.5px}
        .history-table td{padding:10px 12px;border-bottom:1px solid #F3F4F6}
        .history-table tr:hover{background:#F9FAFB}
        .status-badge{padding:3px 8px;border-radius:6px;font-size:11px;font-weight:600}
        .status-generated{background:#DBEAFE;color:#1E40AF}
        .status-edited{background:#D1FAE5;color:#065F46}

        /* ‚îÄ‚îÄ Prompt Box ‚îÄ‚îÄ */
        .prompt-box{
            background:#1F2937;color:#D1D5DB;border-radius:8px;padding:16px;
            font-family:'Courier New',monospace;font-size:12px;max-height:300px;
            overflow-y:auto;white-space:pre-wrap;margin:12px 0;
        }

        .hidden{display:none!important}

        /* ‚îÄ‚îÄ Push Modal ‚îÄ‚îÄ */
        .modal-overlay{
            position:fixed;top:0;left:0;width:100%;height:100%;z-index:200;
            background:rgba(11,37,69,.6);backdrop-filter:blur(4px);
            display:flex;align-items:center;justify-content:center;
        }
        .modal{
            background:white;border-radius:16px;width:95%;max-width:680px;
            max-height:90vh;overflow-y:auto;box-shadow:0 25px 60px rgba(0,0,0,.3);
        }
        .modal-header{
            padding:20px 24px;border-bottom:1px solid #E5E7EB;display:flex;
            justify-content:space-between;align-items:center;position:sticky;top:0;
            background:white;border-radius:16px 16px 0 0;z-index:1;
        }
        .modal-header h2{font-family:'Playfair Display',serif;font-size:18px;color:#0B2545;margin:0}
        .modal-close{width:32px;height:32px;border:none;background:#F3F4F6;border-radius:8px;font-size:18px;cursor:pointer;color:#6B7280}
        .modal-close:hover{background:#E5E7EB}
        .modal-body{padding:24px}
        .modal-footer{padding:16px 24px;border-top:1px solid #E5E7EB;display:flex;gap:10px;justify-content:flex-end;position:sticky;bottom:0;background:white;border-radius:0 0 16px 16px}

        .form-row{margin-bottom:16px}
        .form-row label{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:5px}
        .form-row .hint{font-size:11px;color:#9CA3AF;margin-top:3px}
        .form-select,.form-input{
            width:100%;padding:10px 12px;border:2px solid #E5E7EB;border-radius:8px;
            font-size:14px;font-family:inherit;transition:border-color .2s;
        }
        .form-select:focus,.form-input:focus{outline:none;border-color:#0EA5A0;box-shadow:0 0 0 3px rgba(14,165,160,.08)}
        .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

        .mode-tabs{display:flex;gap:4px;margin-bottom:20px;background:#F3F4F6;border-radius:8px;padding:4px}
        .mode-tab{
            flex:1;padding:8px;text-align:center;border-radius:6px;cursor:pointer;
            font-size:13px;font-weight:600;color:#6B7280;transition:all .2s;border:none;background:transparent;font-family:inherit;
        }
        .mode-tab.active{background:white;color:#0B2545;box-shadow:0 1px 3px rgba(0,0,0,.1)}

        .treatment-checklist{
            max-height:180px;overflow-y:auto;border:2px solid #E5E7EB;border-radius:8px;padding:10px;
        }
        .treatment-checklist label{
            display:flex;align-items:center;gap:8px;padding:4px 0;font-size:13px;font-weight:400;cursor:pointer;
        }
        .treatment-checklist input[type=checkbox]{accent-color:#0EA5A0;width:16px;height:16px}
        .treatment-checklist .empty{color:#9CA3AF;font-size:13px;padding:8px 0}

        .doctor-search-results{max-height:180px;overflow-y:auto;border:1px solid #E5E7EB;border-radius:8px;margin-top:8px}
        .doctor-search-item{
            padding:10px 14px;cursor:pointer;border-bottom:1px solid #F3F4F6;font-size:13px;transition:background .1s;
        }
        .doctor-search-item:hover{background:#F0FDFA}
        .doctor-search-item .name{font-weight:600}
        .doctor-search-item .meta{color:#9CA3AF;font-size:11px}
        .doctor-search-item.selected{background:#D1FAE5;border-left:3px solid #0EA5A0}

        .push-success{text-align:center;padding:24px}
        .push-success .icon{font-size:48px;margin-bottom:12px}
        .push-success h3{color:#065F46;font-size:18px;margin-bottom:8px}
        .push-success a{color:#0EA5A0;text-decoration:none;font-weight:600}

        @media(max-width:768px){
            .stats-row{grid-template-columns:repeat(2,1fr)}
            .topbar-nav{display:none}
            .form-grid,.form-grid-3{grid-template-columns:1fr}
        }
    </style>
</head>
<body>
    <!-- ‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê -->
    <div class="topbar">
        <div class="topbar-left">
            <div class="topbar-logo">ü´ö</div>
            <span class="topbar-title">Ginger Universe</span>
        </div>
        <div class="topbar-nav">
            <a href="/dashboard" class="active">Generator</a>
            <a href="/history">History</a>
            {% if user.role == 'super_admin' %}
                <a href="/prompts">Prompts</a>
            {% endif %}
        </div>
        <div class="topbar-right">
            {% if claude_available %}
                <span class="badge badge-green">‚ö° Auto</span>
            {% else %}
                <span class="badge badge-amber">üìã Manual</span>
            {% endif %}
            <span class="badge badge-blue">{{ user.role }}</span>
            <span style="opacity:.7">{{ user.name or user.email }}</span>
            <a href="/logout" class="btn-sm btn-ghost">Logout</a>
        </div>
    </div>

    <div class="main">
        <!-- ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">Profiles Generated</div>
                <div class="stat-value">{{ stats.total or 0 }}</div>
                <div class="stat-sub">{{ stats.today or 0 }} today</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">This Week</div>
                <div class="stat-value">{{ stats.week or 0 }}</div>
                <div class="stat-sub">profiles generated</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Treatment Dictionary</div>
                <div class="stat-value">{{ treatment_count or 0 }}</div>
                <div class="stat-sub">across {{ specialty_count or 0 }} specialties</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">AI Engine</div>
                <div class="stat-value" style="font-size:16px;margin-top:8px">Claude Sonnet</div>
                <div class="stat-sub">{% if claude_available %}Connected{% else %}Manual mode{% endif %}</div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê GENERATOR ‚ïê‚ïê‚ïê -->
        <div class="card">
            <h2>üîç Generate Doctor Profile</h2>
            <p style="font-size:13px;color:#6B7280;margin-bottom:16px">
                Enter one or more URLs from hospital websites. The system will scrape all pages, match to our treatment dictionary, and generate a professional profile.
            </p>

            <div class="url-area" id="urlArea">
                <div class="url-row">
                    <input type="url" class="url-input" placeholder="https://hospital-website.com/doctor/dr-name" autofocus>
                    <button class="url-remove hidden" onclick="removeUrl(this)" title="Remove">‚úï</button>
                </div>
            </div>
            <button class="add-url-btn" onclick="addUrlRow()">+ Add another URL</button>

            <!-- Manual text fallback -->
            <div style="margin-top:16px">
                <div style="display:flex;align-items:center;gap:8px;cursor:pointer;color:#6B7280;font-size:13px" onclick="toggleManualInput()">
                    <span id="manualToggleIcon">‚ñ∂</span>
                    <span>üìù <strong>Paste doctor info manually</strong> (if scraper can't read the website)</span>
                </div>
                <div id="manualInputWrap" class="hidden" style="margin-top:10px">
                    <textarea id="manualText" style="width:100%;min-height:150px;padding:12px;border:2px solid #E5E7EB;border-radius:8px;font-size:13px;font-family:inherit;resize:vertical;line-height:1.6" placeholder="Paste the doctor's information here ‚Äî name, qualifications, specialties, experience, hospital affiliations, procedures performed, awards, etc.

You can copy-paste from the hospital website, a CV, or type it manually. The more detail you provide, the better the generated profile will be."></textarea>
                    <div class="hint" style="font-size:11px;color:#9CA3AF;margin-top:4px">This text will be sent to Claude alongside any scraped content. You can use this even without URLs.</div>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-orange" id="generateBtn" onclick="generateProfile()">‚ö° Generate Profile</button>
            </div>

            <div id="statusBar" class="status-bar"></div>
        </div>

        <!-- ‚ïê‚ïê‚ïê SCRAPED DATA SUMMARY ‚ïê‚ïê‚ïê -->
        <div id="scrapeCard" class="card hidden">
            <h3>üìä Scraped Data Summary</h3>
            <div id="scrapeSummary" class="scrape-summary"></div>
        </div>

        <!-- ‚ïê‚ïê‚ïê PROFILE EDITOR ‚ïê‚ïê‚ïê -->
        <div id="editorCard" class="card hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <h2 id="profileTitle">‚úèÔ∏è Generated Profile</h2>
                <div id="profileIdBadge" class="hidden" style="font-size:12px;color:#9CA3AF"></div>
            </div>
            <div class="editor-toolbar">
                <button class="btn btn-teal" onclick="downloadDoc()">‚¨á Download .docx</button>
                <button class="btn btn-navy" onclick="openPushModal()">üöÄ Push to Admin</button>
                <button class="btn btn-outline" onclick="copyProfile()">üìã Copy Text</button>
                <button class="btn btn-outline" onclick="saveProfile()">üíæ Save Changes</button>
                <button class="btn btn-outline" onclick="regenerate()">üîÑ Regenerate</button>
                <button class="btn btn-outline" onclick="togglePrompt()">üëÅ View Prompt</button>
            </div>
            <textarea id="profileEditor" class="editor-area"></textarea>
        </div>

        <!-- ‚ïê‚ïê‚ïê PROMPT VIEWER ‚ïê‚ïê‚ïê -->
        <div id="promptCard" class="card hidden">
            <h3>üß† Prompt Sent to Claude</h3>
            <div id="promptBox" class="prompt-box"></div>
            <button class="btn btn-outline" onclick="copyPrompt()">üìã Copy Prompt</button>
        </div>

        <!-- ‚ïê‚ïê‚ïê RECENT HISTORY ‚ïê‚ïê‚ïê -->
        {% if recent_profiles %}
        <div class="card">
            <h2>üìÅ Recent Profiles</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Doctor</th>
                        <th>Status</th>
                        <th>Created By</th>
                        <th>Date</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in recent_profiles %}
                    <tr>
                        <td style="font-weight:600">{{ p.doctor_name or 'Untitled' }}</td>
                        <td><span class="status-badge status-{{ p.status }}">{{ p.status }}</span></td>
                        <td style="color:#6B7280">{{ p.created_by }}</td>
                        <td style="color:#6B7280;font-size:12px">{{ p.created_at.strftime('%b %d, %H:%M') if p.created_at else '' }}</td>
                        <td><button class="btn-sm btn-outline" onclick="loadProfile({{ p.id }})">Open</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- ‚ïê‚ïê‚ïê PUSH TO ADMIN MODAL ‚ïê‚ïê‚ïê -->
    <div id="pushModal" class="modal-overlay hidden" onclick="if(event.target===this)closePushModal()">
        <div class="modal">
            <div class="modal-header">
                <h2>üöÄ Push to Admin Dashboard</h2>
                <button class="modal-close" onclick="closePushModal()">‚úï</button>
            </div>

            <!-- Loading state (AI extracting) -->
            <div id="pushLoading" class="hidden" style="padding:40px;text-align:center">
                <div class="spinner" style="width:24px;height:24px;margin:0 auto 12px;border-width:3px"></div>
                <div style="font-weight:600;color:#0B2545">AI is auto-filling fields...</div>
                <div style="color:#9CA3AF;font-size:13px;margin-top:4px">Extracting doctor info from the generated profile</div>
            </div>

            <!-- Success state -->
            <div id="pushSuccess" class="push-success hidden">
                <div class="icon">‚úÖ</div>
                <h3 id="pushSuccessTitle">Doctor created!</h3>
                <p style="color:#6B7280;margin-bottom:16px" id="pushSuccessMsg"></p>
                <div style="display:flex;gap:10px;justify-content:center">
                    <a id="pushAdminLink" href="#" target="_blank" class="btn btn-teal" style="text-decoration:none;display:inline-block">Open in Doctor Studio ‚Üí</a>
                    <button class="btn btn-outline" onclick="closePushModal()">Close</button>
                </div>
            </div>

            <!-- Form state -->
            <div id="pushForm" class="hidden">
                <div class="modal-body">
                    <!-- Mode tabs -->
                    <div class="mode-tabs">
                        <button class="mode-tab active" onclick="setPushMode('new')">‚ûï Create New Doctor</button>
                        <button class="mode-tab" onclick="setPushMode('update')">‚úèÔ∏è Update Existing</button>
                    </div>

                    <!-- Update existing: doctor search -->
                    <div id="updateSection" class="hidden">
                        <div class="form-row">
                            <label>Search Existing Doctor</label>
                            <input type="text" class="form-input" id="doctorSearch" placeholder="Type doctor name..." oninput="searchDoctors(this.value)">
                            <div id="doctorSearchResults" class="doctor-search-results hidden"></div>
                        </div>
                    </div>

                    <!-- AI confidence note -->
                    <div id="aiNote" class="hidden" style="background:#F0FDFA;border:1px solid #99F6E4;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:#0F766E">
                        ‚ú® Fields auto-filled by AI. Please review and correct if needed.
                    </div>

                    <!-- Doctor Info -->
                    <div class="form-row">
                        <label>Doctor Name *</label>
                        <div class="form-grid">
                            <select class="form-select" id="pushTitle" style="max-width:100px">
                                <option value="Dr.">Dr.</option>
                                <option value="Prof.">Prof.</option>
                                <option value="Mr.">Mr.</option>
                                <option value="Ms.">Ms.</option>
                            </select>
                            <input type="text" class="form-input" id="pushName" placeholder="Full name">
                        </div>
                    </div>

                    <div class="form-grid-3">
                        <div class="form-row">
                            <label>Destination *</label>
                            <select class="form-select" id="pushDestination" onchange="onDestinationChange()">
                                <option value="">Select country...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Hospital</label>
                            <select class="form-select" id="pushHospital" onchange="onHospitalChange()">
                                <option value="">Select hospital...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Specialty *</label>
                            <select class="form-select" id="pushSpecialty" onchange="onSpecialtyChange()">
                                <option value="">Select specialty...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-row">
                            <label>City</label>
                            <select class="form-select" id="pushCity">
                                <option value="">Select city...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Experience (years)</label>
                            <input type="number" class="form-input" id="pushExperience" placeholder="e.g. 25">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-row">
                            <label>Qualifications</label>
                            <input type="text" class="form-input" id="pushQualifications" placeholder="MBBS, MS, MCh (comma-separated)">
                            <div class="hint">Comma-separated list</div>
                        </div>
                        <div class="form-row">
                            <label>Languages</label>
                            <input type="text" class="form-input" id="pushLanguages" placeholder="English, Hindi (comma-separated)">
                            <div class="hint">Comma-separated list</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label>Short Description</label>
                        <input type="text" class="form-input" id="pushDescription" placeholder="One-line summary (shown in listing cards)">
                    </div>

                    <!-- Treatments checklist with search -->
                    <div class="form-row">
                        <label>Link Treatments <span id="txCount" style="color:#9CA3AF;font-weight:400"></span></label>
                        <input type="text" class="form-input" id="txSearchInput" placeholder="Search treatments..." oninput="filterTreatmentChecklist()" style="margin-bottom:6px;padding:8px 12px;font-size:13px">
                        <div id="treatmentChecklist" class="treatment-checklist">
                            <div class="empty">Select a specialty first to see available treatments</div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-row">
                            <label>Meta Title</label>
                            <input type="text" class="form-input" id="pushMetaTitle" placeholder="SEO title (auto-generated if empty)">
                        </div>
                        <div class="form-row">
                            <label>Publish Status</label>
                            <select class="form-select" id="pushStatus">
                                <option value="draft">Draft (review in admin first)</option>
                                <option value="published">Published (live immediately)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closePushModal()">Cancel</button>
                    <button class="btn btn-navy" id="pushBtn" onclick="executePush()">üöÄ Push to Admin</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ State ‚îÄ‚îÄ
        let currentProfileId = null;
        let currentPrompt = null;
        let currentDoctorName = null;

        // ‚îÄ‚îÄ URL Rows ‚îÄ‚îÄ
        function addUrlRow() {
            const area = document.getElementById('urlArea');
            const row = document.createElement('div');
            row.className = 'url-row';
            row.innerHTML = `
                <input type="url" class="url-input" placeholder="https://another-source.com/doctor">
                <button class="url-remove" onclick="removeUrl(this)" title="Remove">‚úï</button>
            `;
            area.appendChild(row);
            row.querySelector('input').focus();
            updateRemoveButtons();
        }

        function removeUrl(btn) {
            btn.closest('.url-row').remove();
            updateRemoveButtons();
        }

        function updateRemoveButtons() {
            const rows = document.querySelectorAll('.url-row');
            rows.forEach((row, i) => {
                const btn = row.querySelector('.url-remove');
                if (rows.length > 1) btn.classList.remove('hidden');
                else btn.classList.add('hidden');
            });
        }

        function getUrls() {
            return Array.from(document.querySelectorAll('.url-input'))
                .map(i => i.value.trim())
                .filter(Boolean);
        }

        // ‚îÄ‚îÄ Manual Input Toggle ‚îÄ‚îÄ
        function toggleManualInput() {
            const wrap = document.getElementById('manualInputWrap');
            const icon = document.getElementById('manualToggleIcon');
            if (wrap.classList.contains('hidden')) {
                wrap.classList.remove('hidden');
                icon.textContent = '‚ñº';
                document.getElementById('manualText').focus();
            } else {
                wrap.classList.add('hidden');
                icon.textContent = '‚ñ∂';
            }
        }

        // ‚îÄ‚îÄ Generate ‚îÄ‚îÄ
        async function generateProfile() {
            const urls = getUrls();
            const manualText = (document.getElementById('manualText') || {}).value || '';

            if (!urls.length && !manualText.trim()) return showStatus('Enter at least one URL or paste doctor information manually', 'error');

            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            hideResults();

            const sourceDesc = [];
            if (urls.length) sourceDesc.push(urls.length + ' URL(s)');
            if (manualText.trim()) sourceDesc.push('manual input');
            showStatus('<div class="spinner"></div> Scraping ' + sourceDesc.join(' + ') + ' & generating profile...', 'loading');

            try {
                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ urls, manual_text: manualText })
                });
                const data = await res.json();

                if (data.error) {
                    showStatus('Error: ' + data.error, 'error');
                    btn.disabled = false; btn.textContent = '‚ö° Generate Profile';
                    return;
                }

                // Show scrape summary
                if (data.scraped_data) {
                    renderScrapeSummary(data.scraped_data);
                }

                if (data.automated && data.claude_response) {
                    currentProfileId = data.profile_id;
                    currentDoctorName = data.doctor_name;
                    currentPrompt = data.prompt_used;
                    currentScrapedText = (data.scraped_data && data.scraped_data.combined_text) || '';

                    document.getElementById('profileEditor').value = data.claude_response;
                    document.getElementById('profileTitle').textContent = '‚úèÔ∏è ' + (data.doctor_name || 'Generated Profile');
                    if (data.profile_id) {
                        document.getElementById('profileIdBadge').textContent = '#' + data.profile_id;
                        document.getElementById('profileIdBadge').classList.remove('hidden');
                    }
                    document.getElementById('editorCard').classList.remove('hidden');
                    showStatus('‚úÖ Profile generated ‚Äî ' + data.treatment_count + ' treatments in dictionary, matched to doctor\'s specialty', 'success');
                    document.getElementById('editorCard').scrollIntoView({behavior:'smooth',block:'start'});
                } else {
                    currentPrompt = data.prompt;
                    document.getElementById('promptBox').textContent = data.prompt || '';
                    document.getElementById('promptCard').classList.remove('hidden');
                    showStatus(data.api_error
                        ? '‚ö†Ô∏è Claude API error ‚Äî use manual mode. Copy the prompt below.'
                        : 'üìã Manual mode ‚Äî copy the prompt and paste into Claude.ai', 'success');
                }
            } catch(e) {
                showStatus('Network error: ' + e.message, 'error');
            }

            btn.disabled = false;
            btn.textContent = '‚ö° Generate Profile';
        }

        function renderScrapeSummary(data) {
            const el = document.getElementById('scrapeSummary');
            let html = '';
            if (data.urls && data.urls.length) {
                html += '<div style="margin-bottom:8px"><span class="label">Sources:</span>';
                data.urls.forEach(u => { try { html += '<span class="tag tag-blue">' + new URL(u).hostname + '</span>'; } catch(e) { html += '<span class="tag tag-blue">' + u.substring(0,40) + '</span>'; } });
                html += '</div>';
            }
            if (data.titles && data.titles.length) {
                html += '<div style="margin-bottom:8px"><span class="label">Pages:</span>';
                data.titles.forEach(t => html += '<span class="tag tag-green">' + t.substring(0,60) + '</span>');
                html += '</div>';
            }
            if (data.has_manual_text) {
                html += '<div style="margin-bottom:8px"><span class="tag tag-orange">üìù Manual input included</span></div>';
            }
            if (data.errors && data.errors.length) {
                html += '<div style="margin-bottom:8px">';
                data.errors.forEach(e => html += '<div style="color:#DC2626;font-size:12px">‚ö†Ô∏è ' + e + '</div>');
                html += '</div>';
            }
            html += '<div style="color:#9CA3AF;font-size:12px">' +
                    (data.url_count || 0) + ' page(s) scraped, ~' +
                    Math.round((data.total_chars || (data.combined_text||'').length)/1000) + 'KB text extracted</div>';
            el.innerHTML = html;
            document.getElementById('scrapeCard').classList.remove('hidden');
        }

        // ‚îÄ‚îÄ Save / Edit ‚îÄ‚îÄ
        async function saveProfile() {
            if (!currentProfileId) return showStatus('No profile to save ‚Äî generate one first', 'error');
            const content = document.getElementById('profileEditor').value;
            try {
                const res = await fetch('/api/profile/' + currentProfileId + '/save', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ content })
                });
                const data = await res.json();
                showStatus(data.success ? 'üíæ Changes saved!' : 'Save failed', data.success ? 'success' : 'error');
            } catch(e) { showStatus('Error: ' + e.message, 'error'); }
        }

        // ‚îÄ‚îÄ Load from history ‚îÄ‚îÄ
        async function loadProfile(id) {
            try {
                const res = await fetch('/api/profile/' + id);
                const data = await res.json();
                if (data.error) return showStatus(data.error, 'error');

                currentProfileId = data.id;
                currentDoctorName = data.doctor_name;
                currentPrompt = data.prompt_used;

                document.getElementById('profileEditor').value = data.edited_content || data.generated_content || '';
                document.getElementById('profileTitle').textContent = '‚úèÔ∏è ' + (data.doctor_name || 'Profile #' + id);
                document.getElementById('profileIdBadge').textContent = '#' + id;
                document.getElementById('profileIdBadge').classList.remove('hidden');
                document.getElementById('editorCard').classList.remove('hidden');
                document.getElementById('editorCard').scrollIntoView({behavior:'smooth'});
                showStatus('Loaded profile #' + id, 'success');
            } catch(e) { showStatus('Error: ' + e.message, 'error'); }
        }

        // ‚îÄ‚îÄ Download .docx ‚îÄ‚îÄ
        async function downloadDoc() {
            const content = document.getElementById('profileEditor').value;
            if (!content) return;
            showStatus('<div class="spinner"></div> Creating document...', 'loading');
            try {
                const res = await fetch('/create-document', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ doctor_name: currentDoctorName || 'Doctor', content })
                });
                if (res.ok) {
                    const blob = await res.blob();
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    const cd = res.headers.get('Content-Disposition');
                    const m = cd && cd.match(/filename="?([^";\n]*)"?/);
                    a.download = m ? m[1] : 'profile.docx';
                    a.click(); URL.revokeObjectURL(a.href);
                    showStatus('‚úÖ Downloaded!', 'success');
                } else showStatus('Download failed', 'error');
            } catch(e) { showStatus('Error: ' + e.message, 'error'); }
        }

        function regenerate() {
            document.getElementById('editorCard').classList.add('hidden');
            document.querySelector('.url-input').focus();
        }

        // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
        function copyProfile() {
            navigator.clipboard.writeText(document.getElementById('profileEditor').value);
            flashStatus('üìã Copied to clipboard!');
        }
        function copyPrompt() {
            navigator.clipboard.writeText(currentPrompt || document.getElementById('promptBox').textContent);
            flashStatus('üìã Prompt copied!');
        }
        function togglePrompt() {
            const el = document.getElementById('promptCard');
            if (el.classList.contains('hidden')) {
                document.getElementById('promptBox').textContent = currentPrompt || '';
                el.classList.remove('hidden');
                el.scrollIntoView({behavior:'smooth'});
            } else el.classList.add('hidden');
        }

        function showStatus(msg, type) {
            const bar = document.getElementById('statusBar');
            bar.innerHTML = msg;
            bar.className = 'status-bar ' + type;
        }
        function flashStatus(msg) { showStatus(msg, 'success'); setTimeout(() => { document.getElementById('statusBar').className = 'status-bar'; }, 2000); }
        function hideResults() {
            ['scrapeCard','editorCard','promptCard'].forEach(id => document.getElementById(id).classList.add('hidden'));
        }

        // Enter key on last URL input
        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && e.target.classList.contains('url-input')) generateProfile();
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PUSH TO ADMIN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let pushData = null;
        let pushMode = 'new';
        let selectedDoctorId = null;
        let allTreatmentsForSpec = [];
        let currentScrapedText = '';

        const CITY_LIST = ['Delhi NCR','Mumbai','Bengaluru','Chennai','Hyderabad','Kolkata','Pune','Ahmedabad','Guwahati','Gurugram','Noida','Jaipur','Lucknow','Chandigarh','Kochi','Thiruvananthapuram','Coimbatore','Nagpur','Visakhapatnam','Bhubaneswar','Indore','Mangalore'];

        async function openPushModal() {
            const content = document.getElementById('profileEditor').value;
            if (!content) return showStatus('Generate a profile first', 'error');

            // Show modal with loading state
            document.getElementById('pushModal').classList.remove('hidden');
            document.getElementById('pushSuccess').classList.add('hidden');
            document.getElementById('pushForm').classList.add('hidden');
            document.getElementById('pushLoading').classList.remove('hidden');

            // Load dropdown data if not cached
            if (!pushData) {
                try {
                    const res = await fetch('/api/push-data');
                    pushData = await res.json();
                } catch(e) {
                    showStatus('Could not load dropdown data: ' + e.message, 'error');
                    closePushModal();
                    return;
                }
            }

            // Populate all dropdowns
            populateSelect('pushDestination', pushData.destinations, 'name', 'id', d => (d.flag || '') + ' ' + d.name);
            populateSelect('pushSpecialty', pushData.specialties, 'name', 'id', s => (s.icon || '') + ' ' + s.name);
            populateSelect('pushHospital', pushData.hospitals, 'name', 'id', h => h.name + (h.city ? ' ‚Äî ' + h.city : ''));
            populateCitySelect('');

            // AI auto-extract fields
            try {
                const extRes = await fetch('/api/auto-extract', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        profile_text: content,
                        scraped_text: currentScrapedText
                    })
                });
                const ext = await extRes.json();

                if (!ext.error) {
                    // Fill fields from AI extraction
                    if (ext.title) document.getElementById('pushTitle').value = ext.title;
                    if (ext.name) document.getElementById('pushName').value = ext.name;
                    if (ext.destination_id) {
                        document.getElementById('pushDestination').value = ext.destination_id;
                        onDestinationChange(); // cascade hospitals
                    }
                    if (ext.hospital_id) {
                        document.getElementById('pushHospital').value = ext.hospital_id;
                    }
                    if (ext.specialty_id) {
                        document.getElementById('pushSpecialty').value = ext.specialty_id;
                        await onSpecialtyChange(); // cascade treatments
                        // Auto-check treatments that match AI suggestions
                        if (ext.suggested_treatments && ext.suggested_treatments.length) {
                            autoCheckTreatments(ext.suggested_treatments);
                        }
                    }
                    if (ext.city) {
                        setCityValue(ext.city);
                    } else if (ext.hospital_city) {
                        setCityValue(ext.hospital_city);
                    }
                    if (ext.experience_years) document.getElementById('pushExperience').value = ext.experience_years;
                    if (ext.qualifications && ext.qualifications.length) document.getElementById('pushQualifications').value = ext.qualifications.join(', ');
                    if (ext.languages && ext.languages.length) document.getElementById('pushLanguages').value = ext.languages.join(', ');
                    if (ext.description) document.getElementById('pushDescription').value = ext.description;
                    document.getElementById('aiNote').classList.remove('hidden');
                } else {
                    // Fallback: just fill name
                    document.getElementById('pushName').value = currentDoctorName || '';
                    document.getElementById('aiNote').classList.add('hidden');
                }
            } catch(e) {
                console.error('Auto-extract failed:', e);
                document.getElementById('pushName').value = currentDoctorName || '';
                document.getElementById('aiNote').classList.add('hidden');
            }

            // Show form
            document.getElementById('pushLoading').classList.add('hidden');
            document.getElementById('pushForm').classList.remove('hidden');
        }

        function closePushModal() {
            document.getElementById('pushModal').classList.add('hidden');
        }

        function setPushMode(mode) {
            pushMode = mode;
            selectedDoctorId = null;
            document.querySelectorAll('.mode-tab').forEach((t,i) => {
                t.classList.toggle('active', (mode === 'new' && i === 0) || (mode === 'update' && i === 1));
            });
            document.getElementById('updateSection').classList.toggle('hidden', mode === 'new');
        }

        function populateSelect(id, items, labelKey, valueKey, formatter) {
            const sel = document.getElementById(id);
            const current = sel.value;
            sel.innerHTML = sel.options[0].outerHTML;
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item[valueKey];
                opt.textContent = formatter ? formatter(item) : item[labelKey];
                sel.appendChild(opt);
            });
            if (current) sel.value = current;
        }

        function populateCitySelect(preselect) {
            const sel = document.getElementById('pushCity');
            sel.innerHTML = '<option value="">Select city...</option>' +
                CITY_LIST.map(c => '<option value="' + c + '">' + c + '</option>').join('');
            if (preselect) sel.value = preselect;
        }

        function setCityValue(city) {
            const sel = document.getElementById('pushCity');
            // Check if city exists in dropdown
            const exists = Array.from(sel.options).some(o => o.value.toLowerCase() === city.toLowerCase());
            if (exists) {
                sel.value = Array.from(sel.options).find(o => o.value.toLowerCase() === city.toLowerCase()).value;
            } else if (city) {
                // Add it as a custom option
                const opt = document.createElement('option');
                opt.value = city;
                opt.textContent = city;
                sel.appendChild(opt);
                sel.value = city;
            }
        }

        // ‚îÄ‚îÄ Cascading: Destination ‚Üí Hospital + City ‚îÄ‚îÄ
        function onDestinationChange() {
            const destId = document.getElementById('pushDestination').value;
            if (!destId || !pushData) return;

            // Filter hospitals by destination
            const filtered = pushData.hospitals.filter(h =>
                h.destination_id == destId
            );
            populateSelect('pushHospital',
                filtered.length ? filtered : pushData.hospitals,
                'name', 'id', h => h.name + (h.city ? ' ‚Äî ' + h.city : '')
            );
        }

        // ‚îÄ‚îÄ Cascading: Hospital ‚Üí City auto-fill ‚îÄ‚îÄ
        function onHospitalChange() {
            const hospId = document.getElementById('pushHospital').value;
            if (!hospId || !pushData) return;

            const hosp = pushData.hospitals.find(h => h.id == hospId);
            if (hosp) {
                // Auto-fill city from hospital
                if (hosp.city && !document.getElementById('pushCity').value) {
                    setCityValue(hosp.city);
                }
                // Auto-fill destination from hospital
                if (hosp.destination_id && !document.getElementById('pushDestination').value) {
                    document.getElementById('pushDestination').value = hosp.destination_id;
                }
            }
        }

        // ‚îÄ‚îÄ Cascading: Specialty ‚Üí Treatments ‚îÄ‚îÄ
        async function onSpecialtyChange() {
            const specId = document.getElementById('pushSpecialty').value;
            const container = document.getElementById('treatmentChecklist');
            if (!specId) {
                container.innerHTML = '<div class="empty">Select a specialty first</div>';
                allTreatmentsForSpec = [];
                updateTxCount();
                return;
            }

            container.innerHTML = '<div class="empty">Loading treatments...</div>';
            try {
                const res = await fetch('/api/push-treatments/' + specId);
                allTreatmentsForSpec = await res.json();
                renderTreatmentChecklist();
            } catch(e) {
                container.innerHTML = '<div class="empty">Error loading treatments</div>';
                allTreatmentsForSpec = [];
            }
            updateTxCount();
        }

        function renderTreatmentChecklist() {
            const container = document.getElementById('treatmentChecklist');
            const search = (document.getElementById('txSearchInput').value || '').toLowerCase();
            let filtered = allTreatmentsForSpec;
            if (search) filtered = filtered.filter(t => t.name.toLowerCase().includes(search));

            if (!filtered.length) {
                container.innerHTML = '<div class="empty">' + (search ? 'No matching treatments' : 'No treatments for this specialty') + '</div>';
                return;
            }
            container.innerHTML = filtered.map(t =>
                '<label><input type="checkbox" value="' + t.id + '" onchange="updateTxCount()"' +
                (t._checked ? ' checked' : '') + '> ' + t.name + '</label>'
            ).join('');
        }

        function filterTreatmentChecklist() {
            // Preserve checked state
            document.querySelectorAll('#treatmentChecklist input[type=checkbox]').forEach(cb => {
                const t = allTreatmentsForSpec.find(x => x.id == cb.value);
                if (t) t._checked = cb.checked;
            });
            renderTreatmentChecklist();
        }

        function autoCheckTreatments(suggestedNames) {
            if (!suggestedNames || !suggestedNames.length) return;
            const lowerNames = suggestedNames.map(n => n.toLowerCase());
            allTreatmentsForSpec.forEach(t => {
                t._checked = lowerNames.some(sn =>
                    t.name.toLowerCase().includes(sn) || sn.includes(t.name.toLowerCase())
                );
            });
            renderTreatmentChecklist();
            updateTxCount();
        }

        function updateTxCount() {
            const checked = document.querySelectorAll('#treatmentChecklist input[type=checkbox]:checked').length;
            const total = allTreatmentsForSpec.length;
            document.getElementById('txCount').textContent = total ? '(' + checked + '/' + total + ' selected)' : '';
        }

        // ‚îÄ‚îÄ Doctor search (update mode) ‚îÄ‚îÄ
        let searchTimer = null;
        function searchDoctors(query) {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(async () => {
                if (query.length < 2) {
                    document.getElementById('doctorSearchResults').classList.add('hidden');
                    return;
                }
                try {
                    const res = await fetch('/api/search-doctors?q=' + encodeURIComponent(query));
                    const doctors = await res.json();
                    const container = document.getElementById('doctorSearchResults');
                    if (!doctors.length) {
                        container.innerHTML = '<div class="doctor-search-item"><span class="meta">No doctors found</span></div>';
                    } else {
                        container.innerHTML = doctors.map(d =>
                            '<div class="doctor-search-item" onclick="selectExistingDoctor(' + d.id + ',\'' +
                            (d.name||'').replace(/'/g,"\\'") + '\')">' +
                            '<div class="name">' + d.name + '</div>' +
                            '<div class="meta">' + (d.specialty||'') + ' ¬∑ ' + (d.city||'') + ', ' + (d.country||'') +
                            ' ¬∑ ' + d.status + '</div></div>'
                        ).join('');
                    }
                    container.classList.remove('hidden');
                } catch(e) { console.error(e); }
            }, 300);
        }

        function selectExistingDoctor(id, name) {
            selectedDoctorId = id;
            document.getElementById('pushName').value = name;
            document.getElementById('doctorSearch').value = name;
            document.getElementById('doctorSearchResults').classList.add('hidden');
        }

        // ‚îÄ‚îÄ Execute Push ‚îÄ‚îÄ
        async function executePush() {
            const btn = document.getElementById('pushBtn');
            btn.disabled = true;
            btn.textContent = 'Pushing...';

            const name = document.getElementById('pushName').value.trim();
            if (!name) { btn.disabled = false; btn.textContent = 'üöÄ Push to Admin'; alert('Doctor name is required'); return; }

            const treatmentIds = Array.from(
                document.querySelectorAll('#treatmentChecklist input[type=checkbox]:checked')
            ).map(cb => parseInt(cb.value));

            const profileContent = document.getElementById('profileEditor').value;

            const payload = {
                profile_id: currentProfileId,
                existing_doctor_id: pushMode === 'update' ? selectedDoctorId : null,
                name: name,
                title: document.getElementById('pushTitle').value,
                destination_id: parseInt(document.getElementById('pushDestination').value) || null,
                hospital_id: parseInt(document.getElementById('pushHospital').value) || null,
                specialty_id: parseInt(document.getElementById('pushSpecialty').value) || null,
                city: document.getElementById('pushCity').value,
                country: document.getElementById('pushDestination').selectedOptions[0]?.textContent.trim() || '',
                experience_years: parseInt(document.getElementById('pushExperience').value) || null,
                qualifications: document.getElementById('pushQualifications').value.split(',').map(s => s.trim()).filter(Boolean),
                languages: document.getElementById('pushLanguages').value.split(',').map(s => s.trim()).filter(Boolean),
                description: document.getElementById('pushDescription').value.trim(),
                long_description: profileContent,
                treatment_ids: treatmentIds,
                meta_title: document.getElementById('pushMetaTitle').value.trim() || ('Dr. ' + name + ' ‚Äî Ginger Healthcare'),
                meta_description: document.getElementById('pushDescription').value.trim().substring(0, 160),
                status: document.getElementById('pushStatus').value
            };

            try {
                const res = await fetch('/api/push-doctor', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await res.json();

                if (result.success) {
                    document.getElementById('pushForm').classList.add('hidden');
                    document.getElementById('pushSuccess').classList.remove('hidden');
                    document.getElementById('pushSuccessTitle').textContent =
                        result.is_update ? 'Doctor updated!' : 'Doctor created!';
                    document.getElementById('pushSuccessMsg').textContent =
                        'ID: #' + result.doctor_id + ' ¬∑ Slug: ' + result.slug +
                        ' ¬∑ Status: ' + payload.status;

                    // Link to Doctor Studio in admin (NOT the public website)
                    const adminLink = document.getElementById('pushAdminLink');
                    adminLink.href = '{{ admin_url }}/doctors/edit/' + result.doctor_id;

                    showStatus('üöÄ Doctor ' + (result.is_update ? 'updated' : 'pushed') + ' to admin! ID: #' + result.doctor_id, 'success');
                } else {
                    alert('Push failed: ' + (result.error || 'Unknown error'));
                }
            } catch(e) {
                alert('Error: ' + e.message);
            }

            btn.disabled = false;
            btn.textContent = 'üöÄ Push to Admin';
        }
    </script>
</body>
</html>
